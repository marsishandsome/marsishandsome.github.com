<!DOCTYPE html>
<!--
  Copyright 2010 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Original slides: Marcin Wichary (mwichary@google.com)
  Modifications: Ernest Delgado (ernestd@google.com)
                 Alex Russell (slightlyoff@chromium.org)

  landslide modifications: Adam Zapletal (adamzap@gmail.com)
                           Nicolas Perriault (nperriault@gmail.com)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Hadoop Kerberos的那些坑 <br />顾亮亮 <br />2015.11.03</title>
    <!-- Styles -->
    
    <link rel="stylesheet" media="print" href="file://c:\Python34\lib\site-packages\landslide-1.1.3-py3.4.egg\landslide\themes\default\css\print.css">
    <link rel="stylesheet" media="screen, projection" href="file://c:\Python34\lib\site-packages\landslide-1.1.3-py3.4.egg\landslide\themes\default\css\screen.css">
    
    
    <!-- /Styles -->
    <!-- Javascripts -->
    
    <script type="text/javascript" src="file://c:\Python34\lib\site-packages\landslide-1.1.3-py3.4.egg\landslide\themes\default\js\slides.js"></script>
    
    
    
    <!-- /Javascripts -->
</head>
<body>
  <div id="blank"></div>
  <div class="presentation">
    <div id="current_presenter_notes">
      <div id="presenter_note"></div>
    </div>
    <div class="slides">
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-1">
          <div class="inner">
            
            <header><h1>Hadoop Kerberos的那些坑 <br />顾亮亮 <br />2015.11.03</h1></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              1/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-2">
          <div class="inner">
            
            <header><h1>Agenda</h1></header>
            
            
            <section><ul>
<li>Kerberos Introduction</li>
<li>Token Expired Problem when Hadoop meet Kerberos</li>
<li>How Spark solve the Problem</li>
<li>Hadoop Kerberos Programming API</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              2/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-3">
          <div class="inner">
            
            <header><h1>Kerberos (百度百科)</h1></header>
            
            
            <section><blockquote>
<p>Kerberos这一名词来源于希腊神话 三个头的狗——地狱之门守护者</p>
</blockquote>
<p><img alt="" src="file://E:\Workspace\marsishandsome.github.com\slides\HadoopSecurity\images/kerberos.jpg" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              3/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-4">
          <div class="inner">
            
            <header><h1>Kerberos (Wikipedia)</h1></header>
            
            
            <section><blockquote>
<p>Kerberos /ˈkərbərəs/ is a computer network authentication protocol which works on the basis of 'tickets' to allow nodes communicating over a non-secure network to prove their identity to one another in a secure manner.</p>
</blockquote>
<p><img alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4e/Kerberos.svg/440px-Kerberos.svg.png" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              4/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-5">
          <div class="inner">
            
            <header><h1>Authentication(认证) VS Authorization(授权)</h1></header>
            
            
            <section><ul>
<li>
<p>Authentication</p>
<blockquote>
<p>is the act of confirming the truth of an attribute of a single piece of data claimed true by an entity.</p>
</blockquote>
</li>
<li>
<p>Authorization</p>
<blockquote>
<p>is the function of specifying access rights to
resources related to information security and computer security in general and to access control in particular.</p>
</blockquote>
</li>
</ul>
<p><strong>Authentication is about who somebody is.</strong></p>
<p><strong>Authorisation is about what they're allowed to do.</strong></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              5/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-6">
          <div class="inner">
            
            <header><h1>Step 1: Authentication Service - TGT Delivery</h1></header>
            
            
            <section><p><strong>TGT: Ticket Granting Ticket</strong>
<img alt="" src="file://E:\Workspace\marsishandsome.github.com\slides\HadoopSecurity\images/kerberos2.PNG" />
From: <a href="http://www.kerberos.org/software/adminkerberos.pdf">The MIT Kerberos Administrator’s How-to Guide</a></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              6/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-7">
          <div class="inner">
            
            <header><h1>Step 2: Ticket Granting Service - TGS Delivery</h1></header>
            
            
            <section><p><strong>TGS: Ticket Granting Service</strong>
<img alt="" src="file://E:\Workspace\marsishandsome.github.com\slides\HadoopSecurity\images/kerberos3.PNG" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              7/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-8">
          <div class="inner">
            
            <header><h1>Diagrams</h1></header>
            
            
            <section><p><img alt="" src="file://E:\Workspace\marsishandsome.github.com\slides\HadoopSecurity\images/kerberos1.PNG" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              8/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-9">
          <div class="inner">
            
            <header><h1>Overal</h1></header>
            
            
            <section><p><img alt="" src="file://E:\Workspace\marsishandsome.github.com\slides\HadoopSecurity\images/kerberos4.PNG" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              9/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-10">
          <div class="inner">
            
            <header><h1>Token Expired Problem when Hadoop meet Kerberos</h1></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              10/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-11">
          <div class="inner">
            
            <header><h1>Hadoop Authentication Flow</h1></header>
            
            
            <section><p><img alt="" src="file://E:\Workspace\marsishandsome.github.com\slides\HadoopSecurity\images/hadoop.PNG" />
From: <a href="http://www.valleytalk.org/wp-content/uploads/2013/03/hadoop-security-design.pdf">Hadoop Security Design</a></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              11/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-12">
          <div class="inner">
            
            <header><h1>HDFS Authentication (Case 1: Sigle JVM Application)</h1></header>
            
            
            <section><p><img alt="" src="file://E:\Workspace\marsishandsome.github.com\slides\HadoopSecurity\images/hadoop2.PNG" /></p>
<ol>
<li>用Keytab从KDC拿到TGT，进而拿到对应NameNode的TGS</li>
<li>用TGS向NameNode做验证，进而拿到BlocksToken</li>
<li>用BlocksToken从DataNode读取数据</li>
</ol>
<h3>Block Token</h3>
<ul>
<li>TokenID = {expirationDate, keyID, ownerID, blockID, accessModes}</li>
<li>TokenAuthenticator = HMAC-SHA1(key, TokenID)</li>
<li>Block Access Token = {TokenID, TokenAuthenticator}</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              12/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-13">
          <div class="inner">
            
            <header><h1>HDFS Authentication (Case 2: Yarn Application)</h1></header>
            
            
            <section><h3><font color="red">Yarn上运行的Executor如何做验证？</font></h3>
<ol>
<li>client用Keytab从KDC拿到TGT，进而拿到对应NameNode的TGS</li>
<li>client用TGS向NameNode做验证，然后获取HDFS Delegation Token</li>
<li>client把HDFS Delegation Token发送到各个Executor</li>
<li>Executor用HDFS Delegation Token向NameNode获取BlocksToken</li>
<li>Executor用BlocksToken从DataNode读取数据</li>
</ol>
<h3>HDFS Delegation Token</h3>
<ul>
<li>TokenID = {ownerID, renewerID, issueDate, maxDate, sequenceNumber}</li>
<li>TokenAuthenticator = HMAC-SHA1(masterKey, TokenID)</li>
<li>Delegation Token = {TokenID, TokenAuthenticator}</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              13/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-14">
          <div class="inner">
            
            <header><h1>Token Expired Problem when Hadoop meet Kerberos</h1></header>
            
            
            <section><ol>
<li>keytab (long term)</li>
<li>TGT (max life time = 3 days)</li>
<li>TGS for NameNode (max life time = 3 days)</li>
<li>HDFS Delegation Token (max life time = 7 days)</li>
<li>Block Access Token (shot time)</li>
</ol>
<p><font color="red"><strong>Proglem: Applications on Yarn cannot run &gt; 7 days</strong></font></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              14/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-15">
          <div class="inner">
            
            <header><h1>How Spark solve the Problem</h1></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              15/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-16">
          <div class="inner">
            
            <header><h1>Old Design</h1></header>
            
            
            <section><p><img alt="" src="file://E:\Workspace\marsishandsome.github.com\slides\HadoopSecurity\images/spark1.PNG" /></p>
<p><font color="red"><strong>Problem: cannot run &gt; 7 days on Yarn</strong></font></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              16/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-17">
          <div class="inner">
            
            <header><h1>New Design from Spark-1.4.0</h1></header>
            
            
            <section><p><img alt="" src="file://E:\Workspace\marsishandsome.github.com\slides\HadoopSecurity\images/spark2.PNG" />
From: <a href="https://issues.apache.org/jira/secure/attachment/12693526/SparkYARN.pdf">Long Running Spark Apps on Secure YARN</a></p>
<p><font color="green"><strong>Upload Keytab to HDFS and login from Keytab before token expired</strong></font></p>
<p><a href="https://issues.apache.org/jira/browse/SPARK-5342">Spark-5342 Allow long running Spark apps to run on secure YARN/HDFS</a></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              17/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-18">
          <div class="inner">
            
            <header><h1>Log Aggregation Token Expire Problem</h1></header>
            
            
            <section><p><strong>Configuring YARN for Long-running Applications (Hadoop 2.6.0)</strong></p>
<ul>
<li><a href="http://www.cloudera.com/content/www/en-us/documentation/enterprise/5-3-x/topics/cm_sg_yarn_long_jobs.html">Configuring YARN for Long-running Applications</a></li>
<li><a href="https://issues.apache.org/jira/browse/YARN-2704">Yarn-2704  Localization and log-aggregation will fail if hdfs delegation token expired after token-max-life-time</a></li>
<li><a href="https://github.com/apache/hadoop/commit/a16d022ca4313a41425c8e97841c841a2d6f2f54?diff=split">Yarn-2704 Github</a></li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              18/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-19">
          <div class="inner">
            
            <header><h1>Hadoop Kerberos Programming API</h1></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              19/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-20">
          <div class="inner">
            
            <header><h1>UserGroupInformation (Hadoop)</h1></header>
            
            
            <section><div class="highlight"><pre><span class="lineno"> 1 </span><span class="c1">// Log a user in from a keytab file. Loads a user identity from a keytab</span>
<span class="lineno"> 2 </span><span class="c1">// file and logs them in. They become the currently logged-in user.</span>
<span class="lineno"> 3 </span><span class="kd">static</span> <span class="kt">void</span> <span class="nf">loginUserFromKeytab</span><span class="o">(</span><span class="n">String</span> <span class="n">user</span><span class="o">,</span> <span class="n">String</span> <span class="n">path</span><span class="o">)</span>
<span class="lineno"> 4 </span>
<span class="lineno"> 5 </span><span class="c1">// Log a user in from a keytab file. Loads a user identity from a keytab</span>
<span class="lineno"> 6 </span><span class="c1">// file and login them in. This new user does not affect the currently</span>
<span class="lineno"> 7 </span><span class="kd">static</span> <span class="n">UserGroupInformation</span> <span class="nf">loginUserFromKeytabAndReturnUGI</span><span class="o">(</span><span class="n">String</span> <span class="n">user</span><span class="o">,</span>
<span class="lineno"> 8 </span>                                                            <span class="n">String</span> <span class="n">path</span><span class="o">)</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="c1">// Return the current user, including any doAs in the current stack.</span>
<span class="lineno">11 </span><span class="kd">static</span> <span class="n">UserGroupInformation</span> <span class="nf">getCurrentUser</span><span class="o">()</span>
<span class="lineno">12 </span>
<span class="lineno">13 </span><span class="c1">// Re-login a user from keytab if TGT is expired or is close to expiry.</span>
<span class="lineno">14 </span><span class="kt">void</span> <span class="nf">checkTGTAndReloginFromKeytab</span><span class="o">()</span>
<span class="lineno">15 </span>
<span class="lineno">16 </span><span class="c1">// Add the given Credentials to this user.</span>
<span class="lineno">17 </span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">addCredentials</span><span class="o">(</span><span class="n">Credentials</span> <span class="n">credentials</span><span class="o">)</span>
<span class="lineno">18 </span>
<span class="lineno">19 </span><span class="kd">public</span> <span class="n">Credentials</span> <span class="nf">getCredentials</span><span class="o">()</span>
<span class="lineno">20 </span>
<span class="lineno">21 </span><span class="c1">// Run the given action as the user.</span>
<span class="lineno">22 </span><span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">doAs</span><span class="o">(</span><span class="n">PrivilegedAction</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              20/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-21">
          <div class="inner">
            
            <header><h1>UserGroupInformation Runtime</h1></header>
            
            
            <section><div class="highlight"><pre><span class="lineno">1 </span><span class="nc">UserGroupInformation</span><span class="o">.</span><span class="n">loginUserFromKeytab</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span> <span class="n">keytab</span><span class="o">)</span>
<span class="lineno">2 </span><span class="k">val</span> <span class="n">ugi</span> <span class="k">=</span> <span class="nc">UserGroupInformation</span><span class="o">.</span><span class="n">getCurrentUser</span>
</pre></div>

<p><img alt="" src="file://E:\Workspace\marsishandsome.github.com\slides\HadoopSecurity\images/ugi1.PNG" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              21/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-22">
          <div class="inner">
            
            <header><h1>Subject (Java)</h1></header>
            
            
            <section><blockquote>
<p>A Subject represents a grouping of related information for a single entity, such as a person. Such information includes the Subject's identities as well as its security-related attributes (passwords and cryptographic keys, for example).</p>
</blockquote></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              22/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-23">
          <div class="inner">
            
            <header><h1>Subject Runtime</h1></header>
            
            
            <section><div class="highlight"><pre><span class="lineno">1 </span><span class="k">val</span> <span class="n">ugi</span> <span class="k">=</span> <span class="nc">UserGroupInformation</span><span class="o">.</span><span class="n">getCurrentUser</span>
</pre></div>

<p><img alt="" src="file://E:\Workspace\marsishandsome.github.com\slides\HadoopSecurity\images/ugi2.PNG" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              23/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-24">
          <div class="inner">
            
            <header><h1>Subject.doAs</h1></header>
            
            
            <section><div class="highlight"><pre><span class="lineno"> 1 </span><span class="cm">/**</span>
<span class="lineno"> 2 </span><span class="cm"> * Perform work as a particular Subject.</span>
<span class="lineno"> 3 </span><span class="cm"> *</span>
<span class="lineno"> 4 </span><span class="cm"> * This method first retrieves the current Thread&#39;s</span>
<span class="lineno"> 5 </span><span class="cm"> * AccessControlContext via AccessController.getContext,</span>
<span class="lineno"> 6 </span><span class="cm"> * and then instantiates a new AccessControlContext</span>
<span class="lineno"> 7 </span><span class="cm"> * using the retrieved context along with a new</span>
<span class="lineno"> 8 </span><span class="cm"> * SubjectDomainCombiner (constructed using the provided Subject).</span>
<span class="lineno"> 9 </span><span class="cm"> * Finally, this method invokes AccessController.doPrivileged,</span>
<span class="lineno">10 </span><span class="cm"> * passing it the provided PrivilegedAction,</span>
<span class="lineno">11 </span><span class="cm"> * as well as the newly constructed AccessControlContext.</span>
<span class="lineno">12 </span><span class="cm"> *</span>
<span class="lineno">13 </span><span class="cm"> * @param subject the Subject that the specified</span>
<span class="lineno">14 </span><span class="cm"> *        action will run as.  This parameter may be null.</span>
<span class="lineno">15 </span><span class="cm"> */</span>
<span class="lineno">16 </span><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">doAs</span><span class="o">(</span><span class="kd">final</span> <span class="n">Subject</span> <span class="n">subject</span><span class="o">,</span>
<span class="lineno">17 </span>                    <span class="kd">final</span> <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">PrivilegedAction</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              24/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-25">
          <div class="inner">
            
            <header><h1>Use Cases</h1></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              25/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-26">
          <div class="inner">
            
            <header><h1>Kerberos Configuration</h1></header>
            
            
            <section><div class="highlight"><pre><span class="lineno">1 </span><span class="nc">System</span><span class="o">.</span><span class="n">setProperty</span><span class="o">(</span><span class="s">&quot;java.security.krb5.realm&quot;</span><span class="o">,</span> <span class="s">&quot;HADOOP.QIYI.COM&quot;</span><span class="o">)</span>
<span class="lineno">2 </span><span class="nc">System</span><span class="o">.</span><span class="n">setProperty</span><span class="o">(</span><span class="s">&quot;java.security.krb5.kdc&quot;</span><span class="o">,</span> <span class="s">&quot;hadoop-kdc01&quot;</span><span class="o">)</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              26/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-27">
          <div class="inner">
            
            <header><h1>Use Case 1: kinit by crontab</h1></header>
            
            
            <section><p>Run once every day in crontab</p>
<div class="highlight"><pre><span class="lineno">1 </span>kinit -l 3d -k -t ~/test.keytab <span class="nb">test</span>@HADOOP.QIYI.COM
</pre></div>

<p><font color="green">Right:</font></p>
<div class="highlight"><pre><span class="lineno">1 </span><span class="k">val</span> <span class="n">fs</span> <span class="k">=</span> <span class="nc">FileSystem</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="k">new</span> <span class="nc">Configuration</span><span class="o">())</span>
<span class="lineno">2 </span><span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">3 </span>  <span class="n">println</span><span class="o">(</span><span class="n">fs</span><span class="o">.</span><span class="n">listFiles</span><span class="o">(</span><span class="k">new</span> <span class="nc">Path</span><span class="o">(</span><span class="s">&quot;/user&quot;</span><span class="o">),</span> <span class="kc">false</span><span class="o">))</span>
<span class="lineno">4 </span>  <span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">)</span>
<span class="lineno">5 </span><span class="o">}</span>
</pre></div>

<p><strong>Kerberos will relogin automatically, when token is expired</strong></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              27/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-28">
          <div class="inner">
            
            <header><h1>Use Case 2: Login with Keytab File</h1></header>
            
            
            <section><p><font color="green">Right:</font></p>
<div class="highlight"><pre><span class="lineno">1 </span><span class="nc">UserGroupInformation</span><span class="o">.</span><span class="n">loginUserFromKeytab</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span> <span class="n">keytab</span><span class="o">)</span>
<span class="lineno">2 </span><span class="k">val</span> <span class="n">fs</span> <span class="k">=</span> <span class="nc">FileSystem</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="k">new</span> <span class="nc">Configuration</span><span class="o">())</span>
<span class="lineno">3 </span><span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">4 </span>  <span class="n">println</span><span class="o">(</span><span class="n">fs</span><span class="o">.</span><span class="n">listFiles</span><span class="o">(</span><span class="k">new</span> <span class="nc">Path</span><span class="o">(</span><span class="s">&quot;/user&quot;</span><span class="o">),</span> <span class="kc">false</span><span class="o">))</span>
<span class="lineno">5 </span>  <span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">)</span>
<span class="lineno">6 </span><span class="o">}</span>
</pre></div>

<p><strong>Kerberos will relogin automatically, when token is expired</strong></p>
<p><font color="red">Wrong:</font></p>
<div class="highlight"><pre><span class="lineno">1 </span><span class="nc">UserGroupInformation</span><span class="o">.</span><span class="n">loginUserFromKeytab</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span> <span class="n">keytab</span><span class="o">)</span>
<span class="lineno">2 </span><span class="k">val</span> <span class="n">fs</span> <span class="k">=</span> <span class="nc">FileSystem</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="k">new</span> <span class="nc">Configuration</span><span class="o">())</span>
<span class="lineno">3 </span><span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">4 </span>  <span class="nc">UserGroupInformation</span><span class="o">.</span><span class="n">loginUserFromKeytab</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span> <span class="n">keytab</span><span class="o">)</span>
<span class="lineno">5 </span>  <span class="n">println</span><span class="o">(</span><span class="n">fs</span><span class="o">.</span><span class="n">listFiles</span><span class="o">(</span><span class="k">new</span> <span class="nc">Path</span><span class="o">(</span><span class="s">&quot;/user&quot;</span><span class="o">),</span> <span class="kc">false</span><span class="o">))</span>
<span class="lineno">6 </span>  <span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">)</span>
<span class="lineno">7 </span><span class="o">}</span>
</pre></div>

<p><strong>Do <font color="red">NOT</font> call UserGroupInformation.loginUserFromKeytab again</strong></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              28/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-29">
          <div class="inner">
            
            <header><h1>Use Case 3: Multi-User in Signle JVM</h1></header>
            
            
            <section><p><font color="red">Wrong:</font></p>
<div class="highlight"><pre><span class="lineno"> 1 </span><span class="k">val</span> <span class="n">ugi</span> <span class="k">=</span> <span class="nc">UserGroupInformation</span><span class="o">.</span><span class="n">loginUserFromKeytabAndReturnUGI</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span>
<span class="lineno"> 2 </span>                                                              <span class="n">keytab</span><span class="o">)</span>
<span class="lineno"> 3 </span><span class="n">ugi</span><span class="o">.</span><span class="n">doAs</span><span class="o">(</span><span class="k">new</span> <span class="nc">PrivilegedExceptionAction</span><span class="o">[</span><span class="kt">Void</span><span class="o">]</span> <span class="o">{</span>
<span class="lineno"> 4 </span>  <span class="k">override</span> <span class="k">def</span> <span class="n">run</span><span class="o">()</span><span class="k">:</span> <span class="kt">Void</span> <span class="o">=</span> <span class="o">{</span>
<span class="lineno"> 5 </span>    <span class="k">val</span> <span class="n">fs</span> <span class="k">=</span> <span class="nc">FileSystem</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="k">new</span> <span class="nc">Configuration</span><span class="o">())</span>
<span class="lineno"> 6 </span>    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 7 </span>      <span class="n">println</span><span class="o">(</span><span class="n">fs</span><span class="o">.</span><span class="n">listFiles</span><span class="o">(</span><span class="k">new</span> <span class="nc">Path</span><span class="o">(</span><span class="s">&quot;/user&quot;</span><span class="o">),</span> <span class="kc">false</span><span class="o">))</span>
<span class="lineno"> 8 </span>      <span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">)</span>
<span class="lineno"> 9 </span>    <span class="o">}</span>
<span class="lineno">10 </span>    <span class="kc">null</span>
<span class="lineno">11 </span>  <span class="o">}</span>
<span class="lineno">12 </span><span class="o">})</span>
</pre></div>

<p><strong>Kerberos will <font color="red">NOT</font> relogin automatically, when token is expired</strong></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              29/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-30">
          <div class="inner">
            
            <header><h1>Use Case 3: Muilti-User in Signle JVM (CONT.)</h1></header>
            
            
            <section><p><font color="green">Right:</font></p>
<div class="highlight"><pre><span class="lineno"> 1 </span><span class="k">val</span> <span class="n">ugi</span> <span class="k">=</span> <span class="nc">UserGroupInformation</span><span class="o">.</span><span class="n">loginUserFromKeytabAndReturnUGI</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span>
<span class="lineno"> 2 </span>                                                              <span class="n">keytab</span><span class="o">)</span>
<span class="lineno"> 3 </span><span class="n">ugi</span><span class="o">.</span><span class="n">doAs</span><span class="o">(</span><span class="k">new</span> <span class="nc">PrivilegedExceptionAction</span><span class="o">[</span><span class="kt">Void</span><span class="o">]</span> <span class="o">{</span>
<span class="lineno"> 4 </span>  <span class="k">override</span> <span class="k">def</span> <span class="n">run</span><span class="o">()</span><span class="k">:</span> <span class="kt">Void</span> <span class="o">=</span> <span class="o">{</span>
<span class="lineno"> 5 </span>    <span class="k">val</span> <span class="n">fs</span> <span class="k">=</span> <span class="nc">FileSystem</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="k">new</span> <span class="nc">Configuration</span><span class="o">())</span>
<span class="lineno"> 6 </span>    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 7 </span>      <span class="nc">UserGroupInformation</span><span class="o">.</span><span class="n">getCurrentUser</span><span class="o">.</span><span class="n">reloginFromKeytab</span><span class="o">()</span>
<span class="lineno"> 8 </span>      <span class="n">println</span><span class="o">(</span><span class="n">fs</span><span class="o">.</span><span class="n">listFiles</span><span class="o">(</span><span class="k">new</span> <span class="nc">Path</span><span class="o">(</span><span class="s">&quot;/user&quot;</span><span class="o">),</span> <span class="kc">false</span><span class="o">))</span>
<span class="lineno"> 9 </span>      <span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">)</span>
<span class="lineno">10 </span>    <span class="o">}</span>
<span class="lineno">11 </span>    <span class="kc">null</span>
<span class="lineno">12 </span>  <span class="o">}</span>
<span class="lineno">13 </span><span class="o">})</span>
</pre></div>

<p><strong>Call reloginFromKeytab before token is expired</strong></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              30/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-31">
          <div class="inner">
            
            <header><h1>Use Case 4: Using HDFS Delegation Token (Yarn Application)</h1></header>
            
            
            <section><p><font color="green">Right:</font></p>
<div class="highlight"><pre><span class="lineno"> 1 </span><span class="k">val</span> <span class="n">creds</span> <span class="k">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">hadoop</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="nc">Credentials</span><span class="o">()</span>
<span class="lineno"> 2 </span><span class="k">val</span> <span class="n">ugi</span> <span class="k">=</span> <span class="nc">UserGroupInformation</span><span class="o">.</span><span class="n">loginUserFromKeytabAndReturnUGI</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span>
<span class="lineno"> 3 </span>                                                                <span class="n">keytab</span><span class="o">)</span>
<span class="lineno"> 4 </span><span class="n">ugi</span><span class="o">.</span><span class="n">doAs</span><span class="o">(</span><span class="k">new</span> <span class="nc">PrivilegedExceptionAction</span><span class="o">[</span><span class="kt">Void</span><span class="o">]</span> <span class="o">{</span>
<span class="lineno"> 5 </span>  <span class="k">override</span> <span class="k">def</span> <span class="n">run</span><span class="o">()</span><span class="k">:</span> <span class="kt">Void</span> <span class="o">=</span> <span class="o">{</span>
<span class="lineno"> 6 </span>    <span class="k">val</span> <span class="n">fs</span> <span class="k">=</span> <span class="nc">FileSystem</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="k">new</span> <span class="nc">Configuration</span><span class="o">())</span>
<span class="lineno"> 7 </span>    <span class="n">fs</span><span class="o">.</span><span class="n">addDelegationTokens</span><span class="o">(</span><span class="s">&quot;test&quot;</span><span class="o">,</span> <span class="n">creds</span><span class="o">)</span>
<span class="lineno"> 8 </span>    <span class="kc">null</span>
<span class="lineno"> 9 </span>  <span class="o">}</span>
<span class="lineno">10 </span><span class="o">})</span>
<span class="lineno">11 </span><span class="nc">UserGroupInformation</span><span class="o">.</span><span class="n">getCurrentUser</span><span class="o">.</span><span class="n">addCredentials</span><span class="o">(</span><span class="n">creds</span><span class="o">)</span>
</pre></div>

<p><strong>Update credentials periodically before token expired</strong></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              31/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-32">
          <div class="inner">
            
            <header><h1>References</h1></header>
            
            
            <section><ul>
<li><a href="http://www.kerberos.org/software/adminkerberos.pdf">The MIT Kerberos Administrator’s How-to Guide</a></li>
<li><a href="http://www.valleytalk.org/wp-content/uploads/2013/03/hadoop-security-design.pdf">Hadoop Security Design</a></li>
<li><a href="https://issues.apache.org/jira/secure/attachment/12693526/SparkYARN.pdf">Long Running Spark Apps on Secure YARN</a></li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              32/33
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: HadoopSecurity/Index.md -->
      <div class="slide-wrapper">
        <div class="slide slide-33">
          <div class="inner">
            
            <header><h1>Related Patches</h1></header>
            
            
            <section><h3>Spark-1.4.0</h3>
<ul>
<li><a href="https://issues.apache.org/jira/browse/SPARK-5342">Spark-5342 Allow long running Spark apps to run on secure YARN/HDFS</a></li>
<li><a href="https://issues.apache.org/jira/browse/SPARK-6918">SPARK-6918 Secure HBase with Kerberos does not work over YARN</a></li>
</ul>
<h3>Spark-1.5.0</h3>
<ul>
<li><a href="https://issues.apache.org/jira/browse/SPARK-8688">Spark-8688 Hadoop Configuration has to disable client cache when writing or reading delegation tokens</a></li>
<li><a href="https://issues.apache.org/jira/browse/SPARK-7524">Spark-7524 add configs for keytab and principal, move originals to internal</a></li>
</ul>
<h3>Submit Patches</h3>
<ul>
<li><a href="https://issues.apache.org/jira/browse/SPARK-11182">Spark-11182 HDFS Delegation Token will be expired when calling "UserGroupInformation.getCurrentUser.addCredentials" in HA mode</a></li>
<li><a href="https://issues.apache.org/jira/browse/HDFS-9276">HDFS-9276 Failed to Update HDFS Delegation Token for long running application in HA mode</a></li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="HadoopSecurity/Index.md">HadoopSecurity/Index.md</a>
            </aside>
            
            <aside class="page_number">
              33/33
            </aside>
          </footer>
        </div>
      </div>
      
    </div>
  </div>
  
  <div id="toc" class="sidebar hidden">
    <h2>Table of Contents</h2>
    <table>
      <caption>Table of Contents</caption>
      
      <tr id="toc-row-1">
        <th><a href="#slide1">Hadoop Kerberos的那些坑 <br />顾亮亮 <br />2015.11.03</a></th>
        <td><a href="#slide1">1</a></td>
      </tr>
      
      
      <tr id="toc-row-2">
        <th><a href="#slide2">Agenda</a></th>
        <td><a href="#slide2">2</a></td>
      </tr>
      
      
      <tr id="toc-row-3">
        <th><a href="#slide3">Kerberos (百度百科)</a></th>
        <td><a href="#slide3">3</a></td>
      </tr>
      
      
      <tr id="toc-row-4">
        <th><a href="#slide4">Kerberos (Wikipedia)</a></th>
        <td><a href="#slide4">4</a></td>
      </tr>
      
      
      <tr id="toc-row-5">
        <th><a href="#slide5">Authentication(认证) VS Authorization(授权)</a></th>
        <td><a href="#slide5">5</a></td>
      </tr>
      
      
      <tr id="toc-row-6">
        <th><a href="#slide6">Step 1: Authentication Service - TGT Delivery</a></th>
        <td><a href="#slide6">6</a></td>
      </tr>
      
      
      <tr id="toc-row-7">
        <th><a href="#slide7">Step 2: Ticket Granting Service - TGS Delivery</a></th>
        <td><a href="#slide7">7</a></td>
      </tr>
      
      
      <tr id="toc-row-8">
        <th><a href="#slide8">Diagrams</a></th>
        <td><a href="#slide8">8</a></td>
      </tr>
      
      
      <tr id="toc-row-9">
        <th><a href="#slide9">Overal</a></th>
        <td><a href="#slide9">9</a></td>
      </tr>
      
      
      <tr id="toc-row-10">
        <th><a href="#slide10">Token Expired Problem when Hadoop meet Kerberos</a></th>
        <td><a href="#slide10">10</a></td>
      </tr>
      
      
      <tr id="toc-row-11">
        <th><a href="#slide11">Hadoop Authentication Flow</a></th>
        <td><a href="#slide11">11</a></td>
      </tr>
      
      
      <tr id="toc-row-12">
        <th><a href="#slide12">HDFS Authentication (Case 1: Sigle JVM Application)</a></th>
        <td><a href="#slide12">12</a></td>
      </tr>
      
      
      <tr id="toc-row-13">
        <th><a href="#slide13">HDFS Authentication (Case 2: Yarn Application)</a></th>
        <td><a href="#slide13">13</a></td>
      </tr>
      
      
      <tr id="toc-row-14">
        <th><a href="#slide14">Token Expired Problem when Hadoop meet Kerberos</a></th>
        <td><a href="#slide14">14</a></td>
      </tr>
      
      
      <tr id="toc-row-15">
        <th><a href="#slide15">How Spark solve the Problem</a></th>
        <td><a href="#slide15">15</a></td>
      </tr>
      
      
      <tr id="toc-row-16">
        <th><a href="#slide16">Old Design</a></th>
        <td><a href="#slide16">16</a></td>
      </tr>
      
      
      <tr id="toc-row-17">
        <th><a href="#slide17">New Design from Spark-1.4.0</a></th>
        <td><a href="#slide17">17</a></td>
      </tr>
      
      
      <tr id="toc-row-18">
        <th><a href="#slide18">Log Aggregation Token Expire Problem</a></th>
        <td><a href="#slide18">18</a></td>
      </tr>
      
      
      <tr id="toc-row-19">
        <th><a href="#slide19">Hadoop Kerberos Programming API</a></th>
        <td><a href="#slide19">19</a></td>
      </tr>
      
      
      <tr id="toc-row-20">
        <th><a href="#slide20">UserGroupInformation (Hadoop)</a></th>
        <td><a href="#slide20">20</a></td>
      </tr>
      
      
      <tr id="toc-row-21">
        <th><a href="#slide21">UserGroupInformation Runtime</a></th>
        <td><a href="#slide21">21</a></td>
      </tr>
      
      
      <tr id="toc-row-22">
        <th><a href="#slide22">Subject (Java)</a></th>
        <td><a href="#slide22">22</a></td>
      </tr>
      
      
      <tr id="toc-row-23">
        <th><a href="#slide23">Subject Runtime</a></th>
        <td><a href="#slide23">23</a></td>
      </tr>
      
      
      <tr id="toc-row-24">
        <th><a href="#slide24">Subject.doAs</a></th>
        <td><a href="#slide24">24</a></td>
      </tr>
      
      
      <tr id="toc-row-25">
        <th><a href="#slide25">Use Cases</a></th>
        <td><a href="#slide25">25</a></td>
      </tr>
      
      
      <tr id="toc-row-26">
        <th><a href="#slide26">Kerberos Configuration</a></th>
        <td><a href="#slide26">26</a></td>
      </tr>
      
      
      <tr id="toc-row-27">
        <th><a href="#slide27">Use Case 1: kinit by crontab</a></th>
        <td><a href="#slide27">27</a></td>
      </tr>
      
      
      <tr id="toc-row-28">
        <th><a href="#slide28">Use Case 2: Login with Keytab File</a></th>
        <td><a href="#slide28">28</a></td>
      </tr>
      
      
      <tr id="toc-row-29">
        <th><a href="#slide29">Use Case 3: Multi-User in Signle JVM</a></th>
        <td><a href="#slide29">29</a></td>
      </tr>
      
      
      <tr id="toc-row-30">
        <th><a href="#slide30">Use Case 3: Muilti-User in Signle JVM (CONT.)</a></th>
        <td><a href="#slide30">30</a></td>
      </tr>
      
      
      <tr id="toc-row-31">
        <th><a href="#slide31">Use Case 4: Using HDFS Delegation Token (Yarn Application)</a></th>
        <td><a href="#slide31">31</a></td>
      </tr>
      
      
      <tr id="toc-row-32">
        <th><a href="#slide32">References</a></th>
        <td><a href="#slide32">32</a></td>
      </tr>
      
      
      <tr id="toc-row-33">
        <th><a href="#slide33">Related Patches</a></th>
        <td><a href="#slide33">33</a></td>
      </tr>
      
      
    </table>
  </div>
  
  <div id="help" class="sidebar hidden">
    <h2>Help</h2>
    <table>
      <caption>Help</caption>
      <tr>
        <th>Table of Contents</th>
        <td>t</td>
      </tr>
      <tr>
        <th>Exposé</th>
        <td>ESC</td>
      </tr>
      <tr>
        <th>Full screen slides</th>
        <td>e</td>
      </tr>
      <tr>
        <th>Presenter View</th>
        <td>p</td>
      </tr>
      <tr>
        <th>Source Files</th>
        <td>s</td>
      </tr>
      <tr>
        <th>Slide Numbers</th>
        <td>n</td>
      </tr>
      <tr>
        <th>Toggle screen blanking</th>
        <td>b</td>
      </tr>
      <tr>
        <th>Show/hide slide context</th>
        <td>c</td>
      </tr>
      <tr>
        <th>Notes</th>
        <td>2</td>
      </tr>
      <tr>
        <th>Help</th>
        <td>h</td>
      </tr>
    </table>
  </div>
  <script>main()</script>
</body>
</html>